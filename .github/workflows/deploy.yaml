name: Deploy Argo Apps

on:
  push:
    branches: [ "main" ]
    # Publish semver tags as releases.
    #tags: [ 'v*.*.*' ]

jobs:
  deloy:
    runs-on: k8s-deployments
    container:
      image: node:18
    permissions:
      contents: read
      packages: write
      # This is used to complete the identity challenge
      # with sigstore/fulcio when running outside of PRs.
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create kubeconfig
        run: |
          echo "$RANCHER_KUBECONFIG >> kubeconfig.yaml
          chmod 600 kubeconfig.yaml

      - uses: azure/setup-kubectl@v3
        with:
          version: '1.26.7' # default is latest stable
        id: install

      - uses: azure/k8s-set-context@v1
        with:
          method: kubeconfig
          kubeconfig: kubeconfig.yaml
          context: rancher
        id: setcontext

      - uses: azure/k8s-deploy@v4
        with:
          action: deploy
          namespace: argocd
          manifests: |
              applicationsets/istio.yaml
